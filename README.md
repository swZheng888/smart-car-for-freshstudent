# smart-car-for-freshstudent

---
# 智能车入门到入土

 ## 前言
 本文默认您已熟练掌握C语言基本语法，在语法与用法上不做讲解
 本文默认您已经对STM32/51单片机有所了解。

 一些闲话：
 我所在的赛区是西部赛区，2022疫情特别严重，我们学校也是在七月初就全部让离校，尽管林老师在尽力争取留校机会，但疫情严重赛点最后还是被迫取消，如果要继续参赛就必须前往其他赛点，我们实验室经过协商选择一部分前往成都比赛另一部分前往东北参加比赛，在去成都的路上我们联系到了电子科技大学的王老师，决定前往电子科技大学参加比赛，但是到了成都，疫情也跟到了成都，我们无法继续调车，只能在酒店天天盼望着进入赛点调车，终于那一天到来了，但电科所在的区域出现疫情，我们无法进入学校，在王老师的协助下我们联系到了成都工业学院的宋老师，在成都工业学院进行比赛，比赛前一天我和我的队友奋战一天，终于完赛，但比赛时在第二圈出现问题始终无法进入环岛，单片机莫名复位，成绩大幅度退步，无缘国赛，但这段经历我会终身难忘。

 
# 第一章 做一辆巡黑线的智能车
## 硬件材料需求
小车底盘
L298N电机驱动
红外模块
STC89C52最小系统
航模电池
降压电池

## 基础知识讲解
### 1.硬件电路连接
#### 1.1 L298N与单片机连接 
![在这里插入图片描述](https://img-blog.csdnimg.cn/33dcdf9371624279977a3bac628d93b5.png#pic_center)

 如上图所示，两个电机的正负极分别接两个L298N的蓝色电机接口，至于到底哪个接正极，哪个接负极，根据你电机安装的方式而定，建议先把电机的两根线焊上，然后把底盘安装起来，这样电机的安装方式就确定了，先随便把两个L298N的4个绿色电机接口跟电机相接，等到把其他信号线接好后，再判断对错并调节，调节方法如下：在程序中让小车往前跑，观察车轮的转向，往前转的车轮的线不用变，把往后转的电机对应的L298N绿色接口的两根线换一下就行了。
   
   剩下的就是L298N的信号线与单片机的连接了，介绍如上图所示，在这里我采用的是双驱的接法，也就是左边两个点击用同一个信号控制，右边两个电机用同一个信号控制，单片机的I/O口自行选择，与程序配合起来就行，我选用的是 ENA接P10 ENB 接P11 IN1接P06 IN2接P05 IN3接P04 IN4接P03 若改为4驱所需的I/O将扩大一倍。


#### 1.2 红外循迹模块与单片机连接
![在这里插入图片描述](https://img-blog.csdnimg.cn/8ef0ebb156e34709a95520f04ea4b455.png)
**1、线路连接**
   传感器与控制板之间的连接很简单，每个传感器与控制板都有3根线相接，即一根VCC，一根GND，还有一根信号线，传感器和控制板上都有白色标识，连线很方便，稍微细心一下就行，别把VCC和GND接反了就行（接反了，一通电传感器可能就烧坏了，我烧过…），控制板与单片机之间的连接，有6根线，一根VCC，一根GND，4根信号线，接法如下：DO1— 第1路TTL电平输出，接在单片机选定的管脚上，如P10，D02—第2路TTL电 平输出，接在单片机选定的管脚上，如P11，DO3—第3路TTL电 平输出，接在单片机选定的管脚上，如P12，DO4—第4路TTL电平输出，接在单片机选定的管脚上，如P13，GND— 接单片机的GND管脚，VCC— 接单片机的5V管脚
   **2、工作原理**
   每1路的传感器的红外发射管不断发射红外线，当发射出的红外线没有被反射回来或被反射回来但强度不够大时，红外接收管一直处于关断状态，此时模块的TTL输出端为高电平，相应指示二极管一直处于熄灭状态;当被检测物体出现在检测范围内时，红外线被反射回来且强度足够大，红外接收管导通，此时模块的TTL输出端为低电平，指示二极管被点亮。
   简单点说，当传感器检测到障碍物时，对应的TTL输出低电平，比如第一路传感器信号线连接在单片机的P10口，当第一路传感器检测到障碍物时，单片机P10口就为低电平，也就是说通过读取传感器信号线连接的单片机I/O口的高低电平，就可以知道传感器前方有没有障碍物。

   **3、检测距离的调节**
   当模块检测到前方障碍物信号时，电路板上红色指示灯点亮电平，同时oUT端口持续输出低电平信号，也就是说，我们可以通过在传感器前面一定距离放置障碍物，通过观察电路板上的指示灯的亮灭，来调节检测距离，检测距离可以通过电位器进行调节，顺时针调电位器，检测距离增加;逆时针调电位器，检测距离减少，官方介绍该模块检测距离2~30cm，但是根据我的实测在20cm以上时，随着距离的增加会趋向不稳定，尤其是在30cm附近，车处于运动状态时可能会由于车的震动从而使传感器始终处于检测到障碍物状态，所以检测距离一般调节在20几厘米左右较好。
   **4、注意事项**
   （1）使用本模块时候，避免探头阳光直射。光线对模块有干扰作用。也就是说本模块受阳光干扰严重，在室外传感器大概率不能正常工作，当然可以采取一定的防护措施，但是效果有限，这也是本次我不采用这种传感器的原因
   （2）灵敏度调节不应过高，过高的灵敏度可能引起误触发。
   （3）在临界值时，会出现ED微亮，这种情况是未触发状态。此时输出为高电平。

### 2. STC89C52单片机基本的外设讲解
#### 2.1 GPIO
概念
GPIO（general purpose intput output）是通用输入输出端口的简称，可以通过软件来控制其输入和输出。51 单片机芯片的 GPIO 引脚与外部设备连接起来，从而实现与外部通讯、 控制以及数据采集的功能。过 GPIO 最简单的应用还属点亮 LED 灯了，只需通过软件控制 GPIO 输出高低电平即可。当然GPIO 还可以作为输入控制，比如在引脚上接入一个按键，通过电平的高低判断按键是否按下。

###### 2.1.1点亮一个LED
![在这里插入图片描述](https://img-blog.csdnimg.cn/b7920abdbb6947f7ad67a75fc0fb1d88.png)
按照上图，我们要如何点亮D1？
答案是让P20处于低电平状态，那么代码如何编写呢？

```c
#include <reg52.h>  //此文件定义单片机的一些特殊功能寄存器
 
sbit D1=P2^0;	   //将单片机的P2.0端口定义为D1
 
void main()      //每一个main.c中必须包含一个主函数，程序从这里开始执行
{
	while(1)   //while死循环，程序将在这里进行不断重读执行
	{
		D1=0;	//P2.0端口设置为低电平，根据二极管原理点亮LED灯			
	}		
}
```

###### 2.1.2 按键检测
![在这里插入图片描述](https://img-blog.csdnimg.cn/bdf0f72e5f2c4c249a1323b355d907a7.png)
如上图所示，我们要如何用程序读取P31按键的状态呢？
如何用按键控制之前的LED呢？

```c
#include <reg52.h>
#include <intrins.h>         //有nop
 
sbit D1=P2^0;
sbit k1=P3^1;
 
void Delay11ms()		//@11.0592MHz，11毫秒 延时函数使用工具生成
{
	unsigned char i, j;
	_nop_();
	_nop_();
	_nop_();
	i = 119;
	j = 82;
	do
	{
		while (--j);
	} while (--i);
}
 
void indpendent_key()
{
	if(k1==0)
	{
		Delay11ms;//延时消抖
		if(k1==0)
		 while(!k1);      //检测按键是否松开
		 D1=!D1;
	}
}
 
 
void main()
{
	while(1)
	{
		independent_key();
	}
}	
```


#### 2.2中断的概念
先看百度百科是怎么定义中断的:

> 中断是指计算机运行过程中，出现某些意外情况需主机干预时，机器能自动停止正在运行的程序并转入处理新情况的程序，处理完毕后又返回原被暂停的程序继续运行。
> —— 百度百科

那么怎么理解中断？看下面的例子。

> 关于中断： 小A正在学习。这时，他的朋友小B叫他一块儿吃鸡，小A停止学习，转去玩吃鸡游戏。玩了几局后，关掉游戏，继续学习。 关于中断优先级：
> 小A正在学习。这时，他的朋友小B叫他一块儿吃鸡，小A停止学习，转去玩吃鸡游戏，（吃鸡过程中，小A女朋友打来电话，于是挂机游戏，去接电话，接完电话，继续游戏。）玩了几局后，关掉游戏，继续学习。

**几个重要概念：**
中断：小A学习被小B打断的过程就称为中断。
中断源：小B被称为中断源。
中断服务程序：小A执行的玩游戏操作称为中断服务程序
中断优先级：小A女朋友的电话比游戏优先级高

**在89c52单片机中，有3类中断源：**

1、外部中断：当外部中断引脚信号产生跳变（低电平→高电平）时引起中断。
2、定时器/计数器中断：当计数器计满溢出时引起跳变。
3、串口中断：串行端口完成一帧数据的发送/接受时引起（如蓝牙传输）。

**其优先级如下表：**

| 中断源 |  优先级 |中断服务号 |
|:--------:| :-------------:|:--------:|
| INT0 外部中断0|最高  |0
| T0 定时器0中断|第二  |1
| INT1 外部中断1|第三  |2
| INT0 外部中断|第四 |3
| 串口中断|第五|4
| T2 定时器0中断|第六  |5


下面以定时器中断为例，讨论中断的编程方法。
##### 2.2.1 为什么要用中断
根据现有的知识，如果要在程序中等待一端时间，想到的操作应该是通过执行若干次空指令，达到延时的效果。
如下：

```c
//延时xms
void delayms(uint xms){
  uint i,j;
  for(i = 0; i < xms; ++i)
    for(j = 0; j < 110; ++j)
    ;
}

```
但是，假设要实现以下功能：

> 1、8位数码管动态扫描显示。 2、LED灯每隔1s闪烁一次。

![在这里插入图片描述](https://img-blog.csdnimg.cn/94a558b67b3c4601a6a9ff43d16eb556.png)

```c
//代码不完整，仅为举例说明
void main(){
  P2 = 0x01;       //数码管从最低位开始扫描
  while(1){
    //功能1：执行数码管动态扫描
    //P2控制显示哪一个数码管，P0控制数码管显示什么内容
    P2 = P2<<1;      //扫描更高一位的数码管
    P0 = xxxx;       //输出段码
    delayms(5);      //延时5ms后显示下一位数码管
  
    //功能2：执行LED灯闪烁
    led = ~led;     //LED灯状态取反
    delayms(1000);  //延时1000ms
  }
}

```
功能1和功能2单独写都没有问题。
但是如果组合在一起，写在一个while循环中，就会有问题了：
一个while循环中有两个延时函数，因此执行一次while循环，共延时了1005ms。这并不是我们所希望的结果。我们希望led闪烁的延时不影响数码管动态扫描的延时。
因此我们可以使用RTOS或者定时器中断来改良这个程序，接下来让我们看看定时器中断是如何实现上述要求的。
##### 2.2.2 中断寄存器
要使用硬件定时，主要涉及到寄存器的操作。51单片机里的关于中断的寄存器如下：
|IE  |–中断允许控制寄存器  |
|-|--|
| IP   |中断优先级控制寄存器  |
| TMOD  |定时器工作方式寄存器  |
|TCON |定时器控制寄存器|  
| SCON  | 串口控制寄存器  
| THx/TLx  |–定时器初值寄存器  


在定时器中断中，需要设置的有TMOD、THx/TLx、TCON、IE。
下面只介绍使用定时器中断所需要设置的寄存器，其余寄存器可自行查阅资料。

##### 2.2.3 中断允许控制寄存器 IE
该寄存器的主要功能是控制中断的开启与关闭，共7个有效位，包含一个全局中断控制位和6个中断源的控制位。
中断允许控制寄存器 IE各位的定义如下表：

![](https://img-blog.csdnimg.cn/99d4d47e9ff34076a8a2c86925000704.png)

说明：
EA 全局中断允许位，当此位是1时中断可用。（重要）
ET2 定时器/计数器2中断允许位
ES 串口中断允许位
ET1 定时器/计数器1中断允许位
EX1 外部中断1允许位
ET0 定时器/计数器0中断允许位 （重要）
EX0 外部中断0允许位
要使用定时器中断，需要将IE寄存器中的EA位设置为1，以及需要将ETx(x = 0,1,2)设置为1。

##### 2.2.4 定时器工作方式寄存器 TMOD
该寄存器的主要功能是设置定时器/计数器中断的工作方式。如设置位定时器模式、定时器模式的计数位的位数。以下是详细介绍：
定时器工作方式寄存器 TMOD各位的定义如下表：

![](https://img-blog.csdnimg.cn/807068b61ce84329afeaf2c0709bdda6.png)

说明：
GATE 定时器/计数器的开关控制选项。常将该位置0，即定时器/计数器的开关控制仅由TCON寄存器中的TRx(x = 0,1)控制。（见2.2.3的TRx）
C/T 定时器模式和计数器模式选择位，将该位置0则为定时器模式。
M1M0 设置定时器/计数器工作方式，常将该两位设置为0 1,其定义如下表：

![、](https://img-blog.csdnimg.cn/c8cf92251db64055a494ed8177bd6e49.png)

##### 2.2.5 定时器控制寄存器 TCON
该寄存器用于控制中断，如控制定时器的启动，停止、判断定时器的溢出和中断情况。
定时器控制寄存器 TCON各位的定义如下表：

**序号	D7	D6	D5	D4	D3	D2	D1	D0
符号	TF1	TR1	TF0	TR0	IE1	IT1	IE0	IT0**
说明：
**TF1 定时器1溢出标志位
TR1 定时器1运行控制位，将该位置1时启动定时器1
TF0 定时器0溢出标志位
TR0 定时器0运行控制位，将该位置1时启动定时器0 （重要）
IE1 外部中断1请求标志
IT1 外部中断1触发方式选择位
IE0 外部中断0请求标志
IT0 外部中断0触发方式选择位**

##### 2.2.6  定时器初值寄存器 THx/TLx
以定时器T0为例，其的工作原理是，每当晶振产生一次脉冲，就将该寄存器TL0加一，当TL0加满溢出后，将TL0清空，TH0加一，TH0计满后产生定时中断。即TH0与TL0组成了一个16位的计数器，这个计数器可以从0x0000（0）加到0xffff（65535）。
**以12Mhz的晶振、定时10ms为例：
51单片机为12分频单片机，因此执行一条指令的时间是12×(1/12M) s，即计数器每1us加一。**
**若定时10ms，则共需要加10000次。
因此将TH0、TL0设置从（65536-10000）= 55536开始计数。55536 的16进制为0xD8F0。因此将TH0设置为0xD8,TL0 设置为0xF0。**


##### 2.2.2 利用定时器生产PWM波



#### 2.3红外模块的使用
### 3. L298N电机驱动使用方法
#### 3.1 利用L298N让电机转起来
### 5.循迹算法实现



#  第二章 电磁循迹小车设计
## 电感循迹的原理
## 硬件电路设计
## 电感数据采集
## 电感数据处理
## 位置式PID算法及参数整定
## 增量式PID算法及参数整定

#  第三章 摄像头循迹小车
### 摄像头循迹的原理
### 摄像头数据采集
### 图片数据二值化方法
### 搜寻边界的方法
### 赛道特殊元素的识别
### 模糊PID算法及参数整定

# 第四章 自平衡单车设计
### 平衡原理讲解
### 串级PID算法的讲解


---
————————————————
红外循迹版权声明：本文为CSDN博主「慕羽★」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/qq_44339029/article/details/106319639

`提示：写完文章后，目录可以自动生成，如何生成可参考右边的帮助文档`




